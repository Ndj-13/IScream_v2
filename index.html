<!DOCTYPE html>
<html lang ="es">
    <head>
        <meta charset="UTF-8">
        <!--meta http-equiv="X-UA-Compatible" content="IE=edge"-->
        <title>IScream vol.2</title>
        <script src="https://cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
        <style type="text/css">
            body{
                margin: 0;
            }
        </style>

        <script src="src/js/SelectPlayer.js"></script>
        <script src="src/js/Player.js"></script>

        <link rel="stylesheet" media="all" href="src/css/stylesheet.css">
        
    </head>

    <body style="text-align: center">

        <div id="introTextoP1">
            <input id="namebar" name="player1T" class="nk-namebar-input" type="text" placeholder="Enter your name...">
            <input id="namebar2" name="player2T" class="nk-namebar-input" type="text" placeholder="Enter your name...">
            <span class="nk-namebar-indicator"></span>
        </div>
        
        <!--script type="text/javascript" src="src/js/game.js"></script-->
        <script type="text/javascript">

            var player1;
            var player2;
            var keys;

            var LoadScreen = new Phaser.Class({
                Extends: Phaser.Scene,

                initialize:

                    function LoadScreen(){
                        Phaser.Scene.call(this, {key:'LoadScreen'});
                    },

                preload: function(){
                    this.load.image('logo', 'resources/img/interface/BakeryStudiosLogo.png');

                    let loadingBar = this.add.graphics({
                        fillStyle: {
                            color: 0xde72ca
                        }
                    })
                    this.load.image('loading', 'resources/img/interface/cabezaMorada.png');

                    //Barra de carga
                    this.load.on("progress", (percent)=>{
                        this.time.delayedCall(1000, () => {
                        loadingBar.fillRect(100, 350, 600*percent, 40);
                        console.log(percent);
                        });
                    })
                    this.load.on("complete", ()=>{
                        console.log('done');
                    })
                },
                create: function()
                {
                    this.add.image(400, 300, 'logo');
                    this.helado = this.add.image(100, 370, 'loading');
                    this.helado.setScale(1.3);
  
                    this.time.delayedCall(2000, () => {
                        this.scene.start('HomeScreen');
                    });
                },
                update: function(){

                }
            });

            var HomeScreen = new Phaser.Class({
                Extends: Phaser.Scene,

                initialize:

                function HomeScreen(){
                    Phaser.Scene.call(this, {key:'HomeScreen'});
                },

                preload: function(){
                    this.load.image('background', 'resources/img/interface/pantallaInicio.png');
                    this.load.image('title', 'resources/img/interface/LogoI-ScreamFondoBlanco.png');
                    this.load.spritesheet('playButton',
                        'resources/img/interface/playbutton.png',
                        { frameWidth: 64, frameHeight: 47 });
                    //this.load.image('markbox', "resources/img/interface/recuadroBoton.png");
                },
                create: function(){
                    this.add.image(400, 300, 'background');
                    this.add.image(game.renderer.width/2, 200, 'title');


                    this.playButton = this.add.sprite(400, 425, "playButton").setInteractive().setScale(2.5);
                    //this.markbox = this.add.image(400, 425, 'markbox').setVisible(false);
                    //this.markbox.setScale(1.2);

                    //Interaccion botones
                    this.playButton.on("pointerover", ()=>{
                        document.body.style.cursor = "pointer";
                        this.playButton.setFrame(1);
                    })

                    this.playButton.on("pointerout", ()=>{
                        document.body.style.cursor = "auto";
                        this.playButton.setFrame(0);
                    })

                    this.playButton.on("pointerdown", ()=>{
                        this.playButton.setFrame(2);
                    })

                    this.playButton.on("pointerup", ()=>{
                        document.body.style.cursor = "auto";
                        this.scene.start("CharacterSelect");
                    })
                },
                update: function(){

                }
            })

            var CharacterSelect = new Phaser.Class({
                Extends: Phaser.Scene,

                initialize:


                function CharacterSelect(){
                    Phaser.Scene.call(this, {key:'CharacterSelect'});
                    player1Panel = new SelectPlayer(this, 225, 'namebar');
                    player2Panel = new SelectPlayer(this, 570, 'namebar2');
                },

                preload: function(){
                    this.load.image("selectScreenBg", "resources/img/interface/pantallaSeleccion.png");
                    
                    //this.load.image('markbox', "resources/img/interface/recuadroBoton.png"); //REPE
                    this.load.image("chMarkbox", "resources/img/interface/eleccionPersonaje.png");

                    //Menu
                    this.load.spritesheet('menu',
                        'resources/img/interface/botonMenu.png',
                        { frameWidth: 120, frameHeight: 47 });

                    player1Panel.preload();
                    player2Panel.preload();
                    /*
                    //Aceptar
                    this.load.spritesheet('ok',
                        'resources/img/interface/botonOk.png',
                        { frameWidth: 120, frameHeight: 47 });
                    
                    
                    this.load.spritesheet('player1',
                        'resources/img/players/SpritesheetP1(Andar).png',
                        { frameWidth: 64, frameHeight: 64 });
                    */
                    //Multiplayer
                    this.load.image("plus", "resources/img/interface/plus.png");

                    this.load.spritesheet('player2',
                        'resources/img/players/SpritesheetP2(Andar).png',
                        { frameWidth: 64, frameHeight: 64 });
                    
                    
                },
                create: function(){
                    this.add.image(400, 300, 'selectScreenBg');

                    //Boton menu: volver al menu
                    this.menu = this.add.sprite(100, 80, "menu").setInteractive();
                    this.marcoMenu = this.add.image(695, 525, 'marco').setVisible(false);

                    player1 = new Player('p1');
                    player1Panel.create();

                    /*
                    //Recuadro personaje 1
                    this.add.image(225, 250, "chMarkbox").setScale(3.5);
  
                    //Personaje 1
                    this.player1 = this.add.sprite(225, 235, 'player1').setInteractive();
                    this.player1.setFrame(3);
                    this.player1.setScale(3);

                    document.getElementById("namebar").style.visibility = "visible";
                    //this.text1.style.marginLeft = '-130px';

                    this.ok1 = this.add.sprite(225, 450, "ok").setInteractive(); 
                    //CAMBIARIA EL OK POR UN READY Y CUANDO ESTEN TODOS READY QUE PASE A LA ESCENA DE JUGAR 

                    this.markbox1 = this.add.image(225, 450, 'markbox').setVisible(false);
                    this.markbox1.setScale(1.2);

                    //Boton menu: volver al menu
                    this.menu = this.add.sprite(100, 80, "menu").setInteractive();
                    this.marcoMenu = this.add.image(695, 525, 'marco').setVisible(false);
                    */
                    //MULTIPLAYER
                    
                    this.newPlayer = this.add.image(570, 250, "chMarkbox").setInteractive();
                    this.plus = this.add.image(570, 250, "plus").setScale(0.1);

                    /*
                    this.markbox2 = this.add.image(570, 250, "chMarkbox").setScale(3.5);
                    this.player2 = this.add.sprite(570, 235, 'player2').setInteractive();
                    this.player2.setFrame(3);
                    this.player2.setScale(3);

                    document.getElementById("namebar2").style.visibility = "visible";
                    document.getElementById("namebar2").style.marginLeft = '45px';
                    //this.text1.style.marginLeft = '-130px';

                    this.ok2 = this.add.sprite(570, 450, "ok").setInteractive(); 
                    //CAMBIARIA EL OK POR UN READY Y CUANDO ESTEN TODOS READY QUE PASE A LA ESCENA DE JUGAR 

                    this.markbox2 = this.add.image(570, 450, 'markbox').setVisible(false);
                    this.markbox2.setScale(1.2);*/

                    //FUNCIONALIDAD
                    //-Players
                    /*
                    this.anims.create({
                        key: 'poseP1',
                        frames: this.anims.generateFrameNumbers('player1', {start: 0, end: 4}),
                        frameRate: 10,
                        repeat: -1
                    })*/
                    /*
                    this.anims.create({
                        key: 'poseP2',
                        frames: this.anims.generateFrameNumbers('player2', {start: 0, end: 4}),
                        frameRate: 10,
                        repeat: -1
                    })*/

                    //-Ok
                    /*
                    this.ok1.on("pointerover", ()=>{
                        document.body.style.cursor = "pointer";
                        this.markbox1.setVisible(true);    
                    })
                    this.ok1.on("pointerout", ()=>{
                        document.body.style.cursor = "auto";
                        this.markbox1.setVisible(false);
                    })
                    this.ok1.on("pointerdown", ()=>{
                        this.markbox1.setVisible(false);
                        this.ok1.setFrame(1);
                        player1T = document.getElementById("namebar");
                        if(player1T.value == null) document.getElementById("namebar").value = "Player1";
                        console.log("Player:"+ player1T.value);
                        player1T.disabled = true;
                    })
                    this.ok1.on("pointerup", ()=>{
                        document.body.style.cursor = "auto";
                        this.scene.start('MainGame');
                        this.ok1.disableInteractive();
                        player1T.style.visibility = "hidden";
                        
                    })*/

                    //-New player
                    this.newPlayer.on("pointerover", ()=>{
                        document.body.style.cursor = "pointer";
                        this.newPlayer.setScale(1.1);
                        this.plus.setScale(0.15);
                    })
                    this.newPlayer.on("pointerout", ()=>{
                        document.body.style.cursor = "auto";
                        this.newPlayer.setScale(1);
                        this.plus.setScale(0.1);
                    })
                    this.newPlayer.on("pointerdown", ()=>{
                        this.newPlayer.setVisible(false);
                        this.plus.setVisible(false);
                        player2Panel.create();
                        player2 = new Player('p2');
                        this.addPlayer = true
                    })
                    this.newPlayer.on("pointerup", ()=>{
                        document.body.style.cursor = "auto";
                    })
  
                    //menu:
                    this.menu.on("pointerover", ()=>{
                        document.body.style.cursor = "pointer";
                        //this.marcoMenu.setVisible(true);
                    })
                    this.menu.on("pointerout", ()=>{
                        document.body.style.cursor = "auto";
                        //this.marcoMenu.setVisible(false);
                    })
                    this.menu.on("pointerdown", ()=>{
                        //this.marcoMenu.setVisible(false);
                        this.menu.setFrame(1);
                    })
                    this.menu.on("pointerup", ()=>{
                        document.body.style.cursor = "auto";
                        player1Panel.desactivarInput();
                        player2Panel.desactivarInput();
                        console.log("VA A HOME")
                        this.scene.start("HomeScreen");
                    })
                    

                },
                update: function(){
                    player1Panel.update();
                    if(this.addPlayer == true) 
                    player2Panel.update();

                    if(this.addPlayer == true){
                        if(player1.confirmReady() && player2.confirmReady()){
                            document.getElementById("namebar").style.visibility = 'hidden';
                            document.getElementById("namebar2").style.visibility = 'hidden';
                            this.scene.start('MainGame');
                            
                        }
                        
                    } else {
                        if(player1.confirmReady()){
                            document.getElementById("namebar").style.visibility = 'hidden';
                            this.scene.start('MainGame');
                        }
                    }
                    
                    //Animacion personajes en pausa
                    //this.player1.anims.play('poseP1', true);
                    //this.player2.anims.play('poseP2', true);
                    /*
                    if(player1Panel.checkReady() && player2Panel.checkReady()){
                        player1Panel.desactivarInput();
                        player2Panel.desactivarInput();
                        console.log("VA A JUEGO")
                        this.scene.start('MainGame');
                    }*/
                }
            })

            var MainGame = new Phaser.Class({
                Extends: Phaser.Scene,

                initialize:

                function MainGame(){
                    Phaser.Scene.call(this, {key:'MainGame'});
                },

                preload: function(){
                    this.load.image('red', 'resources/img/scene/red.png');
                    this.load.image('rock', 'resources/img/scene/rock.png');
                    this.load.image('trans', 'resources/img/scene/trans.png');

                    this.load.image('ground', 'resources/img/scene/platform.png');
                    this.load.spritesheet('player1',
                        'resources/img/players/SpritesheetP1(Andar).png',
                        { frameWidth: 64, frameHeight: 64 });
                },
                create: function(){
                    //SCENE

                    //PLATAFORMAS
                    platforms = this.physics.add.staticGroup();
                    
                    platforms.create(400, 568, 'ground').setScale(2).refreshBody();

                    platforms.create(600, 400, 'ground');
                    platforms.create(50, 250, 'ground');
                    platforms.create(750, 220, 'ground');
                    
                    
                    //CAÑONES
                    canon = this.physics.add.group({
                        allowGravity: false,
                        velocityX: 1000
                    })
                    canon1 = canon.create(200, 0, 'red');

                    canon2 = canon.create(400, 0, 'red');
                    canon2.setTint(0x495BB2);

                    //BOLAS
                    bolas = this.physics.add.group({
                        allowGravity: false,
                        velocityY: 150 
                    });
                    bolaC1 = bolas.create(canon1.body.position.x, canon1.body.position.y + 100, 'rock');

                    //HITBOXES
                    hitbox = this.physics.add.group({
                        allowGravity: false
                    });
                    hitboxL = hitbox.create(-10, 30, 'trans');
                    hitboR = hitbox.create(810, 30, 'trans');


                    // Crear un evento que se ejecute cada 2 segundos
                    let evento = this.time.addEvent({
                        delay: 1000, 
                        callback: createBall, // La función que se ejecutará
                        callbackScope: this, // El ámbito en el que se ejecutará la función (opcional, puede ser 'this' si es en la escena)
                        loop: true // Establecer en true para que se repita
                    });

                    function createBall() {
                        bolaC1 = bolas.create(canon1.body.position.x, canon1.body.position.y + 100, 'rock');
                        //debug
                    }
                    
                    //PLAYER
                    player = this.physics.add.sprite(100, 450, 'player1');
                    player.setBounce(0.2);
                    player.setCollideWorldBounds(true);

                    this.anims.create({
                        key: 'left',
                        frames: this.anims.generateFrameNumbers('player1', { start: 28, end: 32 }),
                        frameRate: 15,
                        repeat: -1
                    });

                    this.anims.create({
                        key: 'stopped',
                        frames: [ { key: 'player1', frame: 0 } ],
                        frameRate: 20
                    });

                    this.anims.create({
                        key: 'right',
                        frames: this.anims.generateFrameNumbers('player1', { start: 21, end: 25 }),
                        frameRate: 15,
                        repeat: -1
                    });

                    //COLLISIONS
                    this.physics.add.collider(player, platforms);

                    //CONTROLS
                    keyInput = this.input.keyboard.createCursorKeys();
                    /*cursors = this.input.keyboard.addKeys({
                        'a': Phaser.Input.Keyboard.KeyCodes.A,
                        'd': Phaser.Input.Keyboard.KeyCodes.D,
                    });*/
                    /*this.keys = this.scene.input.keyboard.addKeys({
                        A: Phaser.Input.Keyboard.KeyCodes.A,
                        B: Phaser.Input.Keyboard.KeyCodes.D
                    });*/
                        
                    

                    
                },
                update: function(){
                    //KEYBOARD
                    if (keyInput.left.isDown)
                    {
                        console.log('A');
                        player.setVelocityX(-160);

                        player.anims.play('left', true);
                    }
                    else if (keyInput.right.isDown)
                    {
                        player.setVelocityX(160);

                        player.anims.play('right', true);
                    }
                    
                    else
                    {
                        player.setVelocityX(0);

                        player.anims.play('stopped');
                    }
                    
                    if (keyInput.up.isDown && player.body.touching.down)
                    {
                        player.setVelocityY(-630);
                    }
                    
                    //colision canon-hitbox
                    this.physics.add.overlap(canon, hitbox, function(canon, hitbox) {
                        console.log("colision hitbox-canon");
                        canon.setVelocityX(canon.body.velocity.x * (-1)); 
                    }, null, this);
                    
                    //colision bola-jugador
                    this.physics.add.overlap(player, bolas, function(player, bolaC1) {
                        //quitar vida jugador   
                        bolaC1.destroy();
                        console.log("colisión player-bola");
                    }, null, this);
                    


                    /*
                    //movimiento canyones
                    if(canon1.x > 748 || canon1.x < 52)
                    {
                        canon1.setVelocityX(canon1.body.velocity.x * (-1));
                    }
                    if(canon2.x > 748 || canon2.x < 52)
                    {
                        canon2.setVelocityX(canon2.body.velocity.x * (-1));
                    }
                    */


                    //debug
                    //console.log("pos canon1: " + canon1.x, canon1.y);
                    //console.log("pos canon2: " + canon2.x, canon2.y);
                    //console.log("pos bolaC1: " + bolaC1.x, bolaC1.y)
                }
            })

            var config = {
                type: Phaser.AUTO,
                width: 800,
                height: 600,
                pixelArt: true,
                physics: {
                    default: 'arcade',
                    arcade: {
                        gravity: {y: 980},
                        debug: true
                    }
                },
        
                backgroundColor: '#5B2970',
        
                /*scene: {  
                    preload: preload,
                    create: create,
                    update: update
                }*/
                scene: [/*LoadScreen, HomeScreen,*/ CharacterSelect, MainGame]
            };
        
            var game = new Phaser.Game(config);
            
            
        </script>
        
    </body>
</html>